<!DOCTYPE html>

<html>
<head>
	<meta charset='utf-8' />
	<title>Wireless_Charging</title>
	<script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
	<link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
	<style>
		body {
			margin:0;
			padding:0;
		}
		.map {
			position:absolute;
			top:0;
			bottom:0;
			width:100%;
			z-index: 0;
		}
		.legend {
			top: 10px;
			right: 10px;
			position: absolute;
			background-color: white;
			border-style: solid;
			border-color: grey;
			border-radius: 3px;
			border-width: 1px;
			font: 12px/20px sans-serif;
			padding: 10px;
			padding-left: 15px;
			padding-right: 15px;
			z-index: 1;
		}
		.legend div img {
			display: inline-block;
			height: 15px;
			margin-right: 5px;
			width: 15px;
		}
		.menu {
			bottom: 30px;
			right: 10px;
			position: absolute;
			background-color: white;
			border-style: solid;
			border-color: grey;
			border-radius: 3px;
			border-width: 1px;
			font: 13px sans-serif;
			padding: 10px;
			z-index: 1;
		}
		.menu div {
			padding: 5px
		}
		.button {
			background-color: white;
			border-color: grey;
			border-radius: 3px;
			border-width: 1px;
			padding: 2px 2px;
			text-align: center;
			display: inline-block;
		}
	</style>
</head>
<body>
	<div id="map_id" class="map"></div>
	<div id="map_legend" class="legend">
		<div><h3>Legend</h3></div>
		<div><img id="image_taxi"/>taxi</div>
		<div><img id="image_Rank_with_taxi"/>Rank_with_taxi</div>
		<div><img id="image_Rank_without_taxi"/>Rank_without_taxi</div>
		<div><img id="image_passenger"/>passenger</div>
	</div>
	<div id="menu" class="menu">
		<div align="center">
			<input type="button" class="button" id="run_pause_button" value="Run" style="width:50px" />
			<input type="button" class="button" id="stop_button" value="Stop" style="width:50px" />
		</div>
		<div>Time: <span id="sim_time" size="8" maxlength="11"></span></div>
		<div>Jump to time: <input id="new_sim_time" type="text" value="" size="7" maxlength="10"></input></div>
		<div>Sim speed: <input id="sim_speed" type="text" value="1" size="5" maxlength="8"></input></div>
		<div>Frame rate: <input id="fps" type="text" value="30" size="1" maxlength="3"></input></div>
		<div>Show destinations <input type="checkbox" id="show_dests"/></div>
	</div>
	
	
	<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.js"></script>
	<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script type="text/javascript">
		
		/////////////////////////////////////////////////////////////////
		// create map
		
		L.mapbox.accessToken = 'pk.eyJ1Ijoia2FsaS1qYXJ2aXMiLCJhIjoiY2trNGszdnBwMTQyYzMycW8wNWh6azFiaiJ9.heYxUk8WRmju37iwj-KQAQ';
		
		const map = L.mapbox.map('map_id')
			.setView([0, 0], 0.2)
			.addLayer(L.mapbox.styleLayer('mapbox://styles/kali-jarvis/ckk6hqgzi02gl17ltlboy6zqb'));
		
		var mapBounds = map.getBounds()
		function resetMapView() {
			map.fitBounds(mapBounds);
			console.log("Done Setting up the map");
		}
		
		////////////////////////////////////////////////////////////////
		// websocket connection
		
		var connection = new WebSocket('ws://'+window.location.host);
		var anim_time;
		// var call_count;

		connection.onmessage = function( message ){
			msgObj = JSON.parse(message.data)
			switch (msgObj.message) 
			{
				// To set the focus on our area of interest.
				case "set_map_view":
					var southWest_lat = msgObj.map_southwest_lat;
					console.log("Recieved southwest_lat co-ordinates", msgObj.map_southwest_lat);
					var southWest_long = msgObj.map_southwest_long;
					console.log("Recieved southwest_long co-ordinates", msgObj.map_southwest_long);
					var northEast_lat = msgObj.map_northeast_lat;
					console.log("Recieved northeast_lat co-ordinates", msgObj.map_northeast_lat);
					var northEast_long = msgObj.map_northeast_long;
					console.log("Recieved northeast_long co-ordinates", msgObj.map_northeast_long);
					mapBounds = L.latLngBounds([southWest_lat, southWest_long], [northEast_lat, northEast_long]);
					resetMapView()
					break;

				// Initialize the animation with clock time = 0
				case "set_start_time":
					updateSimTime(0.00)
					break;
	
				// Set up the icons and link them with the JSON object.
				case "set_icons":
					delete msgObj.message
					setIcons(msgObj)
					break;
		
				// Show the static ranks on the map, with the initial condition.	
				case "add_ranks":
					addRank(msgObj.rank_id, msgObj.rank_name, msgObj.rank_long, msgObj.rank_lat, msgObj.rank_taxi, msgObj.rank_first_taxi, msgObj.rank_first_soc)
					break;

				// Show the static taxi object on the map. They are initially at the ranks themselves.	
				case "add_taxis":
					addTaxi(msgObj.taxi_name, msgObj.taxi_long, msgObj.taxi_lat)
					break;

				// Notification from Julia to mention that the set-up is now completed.
				case "set_up_complete":
					if (state == "running"){
						connection.send("start_the_simulation")
					}else{
						console.log("Press_the_run_button!!!!!!")
						connection.send("wait_for_start")
					}
					break;	

				// Synchronize the Javascript clock with the Julia clock
				case "Current_time":
					updateSimTime(msgObj.time)
					break;
                
				// Show the calls of currently active trips.
				case "update_calls":
					delete_calls()
					update_calls(msgObj.active_id, msgObj.calls_to_show_lat, msgObj.calls_to_show_long)
					connection.send("Calls_updated");
					break;
					
				case "ready_for_next_frame":
					if (state == "running"){	
						connection.send("prepare_next_frame");
					}
					else{
						console.log("Error over here!!!!!!!!!!!!")
					}
					break;

				// Update the Rank dynamics	
				case "update_ranks":
					delete_ranks()
					addRank(msgObj.rank_id, msgObj.rank_name, msgObj.rank_long, msgObj.rank_lat, msgObj.rank_taxi, msgObj.rank_first_taxi, msgObj.rank_first_soc)
					connection.send("Ranks_updated");
					break;

				// Update the taxi locations and draw lines for their trips.	
				case "update_taxis":
					delete_taxis()
					update_taxis(msgObj.taxi_ID, msgObj.taxi_start_lat, msgObj.taxi_start_long, msgObj.taxi_end_lat, msgObj.taxi_end_long)
					connection.send("Taxis_updated");
					break;
				
				// Notification call for the Javascript client to disconnect from Julia server.
				case "got_last_frame":
					console.log("Finished Sim, Closing the Animation")
					state = "paused"
					break;
				
				// Deafult error message.
				default:
					throw new Error("Undefined message type")
			}
		}

		console.log("Finished the switch case and closing the window")
		// window closing
		window.onbeforeunload = function() {
			console.log("disconnecting");
			connection.onclose = function () {}; // disable onclose handler first
			connection.send("disconnect")
			connection.close()
		}
		
		////////////////////////////////////////////////////////////////
		// buttons etc.
		var simSpeed;
		$("#sim_speed").bind('blur keyup',function(e) {
			if (e.type == 'blur' || e.keyCode == '13') {
				simSpeed = parseFloat($('#sim_speed').val());
				$('#sim_speed').val(simSpeed);
				connection.send("Animation_Speed" + simSpeed);
			}
		})

		var state = "paused"; 	// can be: running, paused, stopped
		$('#run_pause_button').on('click', function(){
			if (this.value == "Run" && state == "paused") {
				state = "running";
				document.getElementById("run_pause_button").value = "Pause";
				connection.send("prepare_next_frame");
			} else if (this.value == "Pause" && state == "running") {
				state = "paused";
				document.getElementById("run_pause_button").value = "Run";
				connection.send("pause");
			}
		})

		$('#stop_button').on('click', function(){
			if (state == "running" || state == "paused") {
				state = "stopped"
				stopAnimation();
			}
		})
		
		show_dests.checked = false
		
		////////////////////////////////////////////////////////////////
		// sim/animation states
		
		function stopAnimation() {
			state = "stopped"
			connection.send("stop");
		}
		
		////////////////////////////////////////////////////////////////
		// Sim Time
		function updateSimTime(time) {
			$("#sim_time").text(time);
		}


		////////////////////////////////////////////////////////////////
		// 	Icons
		
		var icons = {};				// This line creates a dictionary for storing different types of icon object.
		
		function setIcons(iconsObj) {
			for (iconName in iconsObj)
			{
				// create icon
				icon = L.icon();
				options = iconsObj[iconName]["options"];
				for (optionName in options) {
					icon.options[optionName] = options[optionName];
				}
				icons[iconName] = icon;
				
				// set icon image in map legend
				imgId = "image_" + iconName;
				setImgSrc(imgId, options.iconUrl);
				scaleDownImgWithinMaxDims(imgId, options.iconSize, [15,15]);
			}
			
			updateMarkerIcons();
		}
		
		function setImgSrc(imgId, src) {
			var elt = document.getElementById(imgId);
			elt.src = src
		}
		
		function scaleDownImgWithinMaxDims(imgId, dims, maxDims) {
			// scale down height and width (dims) to fit in maxDims
			// resulting dims have min value 1 (pixel)
			// no scaling if dims already fits in maxDims
			var s = Math.min(1, maxDims[0]/dims[0], maxDims[1]/dims[1]); // scale factor
			var width = Math.max(1, dims[0]*s);
			var height = Math.max(1, dims[1]*s);
			var elt = document.getElementById(imgId);
			elt.style.width = width + "px";
			elt.style.height = height + "px";
		}
		
		function markerIcon(icon, lat, lon, popup) {
			return L.marker([lat, lon],
					{icon: icon}
				).addTo(map).bindPopup(popup);
		}
		
		
		function updateMarkerIcons() {
			
			for (id in taxi_ranks) {
				taxi_ranks[id].marker.setIcon(icons.Rank_with_taxi);
			}
			for (id in ranks) {
				ranks[id].marker.setIcon(icons.Rank_without_taxi);
			}
			for (id in activeCalls) {
				activeCalls[id].marker.setIcon(icons.passenger);
			}
			for (id in taxis){
				taxis[id].marker.setIcon(icons.taxi);
			}
		}
		
		////////////////////////////////////////////////////////////////
		// Ranks
		
		var ranks = {};
		var taxi_ranks = {};
					
		function addRank(id, name, lon, lat, taxi_no, first_taxi_id, first_taxi_soc) 
		{
			if (taxi_no == 0){
				if (id in ranks) {
					throw new Error("Cannot add Ranks with name " + ranks[id].name + " as it exists already")
				}
				ranks[id] = new Ranks(id, name, lat, lon);
			
			}else if (taxi_no > 0){
				if (id in taxi_ranks) {
					throw new Error("Cannot add Ranks with name " + taxi_ranks[id].name + " as it exists already")
				}
				taxi_ranks[id] = new ranksTaxi(id, name, lat, lon, taxi_no, first_taxi_id, first_taxi_soc);
			}
		}
		
		function Ranks(id, name, lat, lon) {
			this.id = id;
			this.name = name;
			this.marker = markerIcon(icons.Rank_without_taxi, lat, lon, "Rank name : " + name + " ~~~~~~~  Number of taxis : 0");
			console.log("Added rank", name, "to map");
		}
		// L.marker([lat, lon],{icon: icon}).addTo(map).bindPopup(popup);
		
		function ranksTaxi(id, name, lat, lon, taxi_no, first_taxi_id, first_taxi_soc) {
			this.id = id;
			this.name = name;
			this.num = taxi_no;
			this.marker = markerIcon(icons.Rank_with_taxi, lat, lon, "Rank name : " + name + " ~~~~~~~  Number of taxis : " + taxi_no + " ~~~~~~~ First taxi ID (SOC): " + first_taxi_id + "(" + first_taxi_soc + ")");
			console.log("Added rank", name, "to map");
		}

		function delete_ranks(){
			for (id in ranks){
				map.removeLayer(ranks[id].marker)
			}
			ranks = {};
			for (id in taxi_ranks){
				map.removeLayer(taxi_ranks[id].marker)
			} 
			taxi_ranks = {};
		}

		////////////////////////////////////////////////////////////////
		// Taxis

		var tlat;
		var tlong;
		var taxis = {};
		
		function update_taxis(id, slat, slong, elat, elong) {
			if (id in taxis) {
				throw new Error("Cannot add Ranks with name " + id + " as it exists already")
			}
			if (slat != elat && slong != elong){
				tlat = (slat + elat)/2;
				tlong = (slong + elong)/2;
				taxis[id] = new taxi(id, tlat, tlong);
				//addTaxiLines(id, slat, slong, elat, elong);
			}
			
		}
		
		function taxi(id, lat, lon) {
			this.id = id;
			this.marker = markerIcon(icons.taxi, lat, lon, "Taxi ID : " + id );
			console.log("Added taxi", id, "to map");
		}
		
//		function moveTaxi(id, lat, lon) {
//			var t = taxis[id]
//			t.marker.setLatLng([lat, lon])
//		}
		
		function delete_taxis() {
			for (id in taxis) {
				map.removeLayer(taxis[id].marker)
			}
			//hideAmbDests()
			taxis = {}
		}
		
		function addTaxiLines(id, slat, slong, elat, elong){

		}
		//////////////////////////////////////////////////////////////////////////////
		// Calls

		var activeCalls = {}

		function delete_calls(){
			for (id in activeCalls){
				map.removeLayer(activeCalls[id].marker)
			}
			activeCalls = {};
		}

		function update_calls(id, lat, long){
			if (id in activeCalls) {
				throw new Error("Cannot add Ranks with name " + id + " as it exists already")
			}
			activeCalls[id] = new ActiveCalls(id, lat, long);
		}

		function ActiveCalls(id, lat, lon) {
			this.id = id;
			this.marker = markerIcon(icons.passenger, lat, lon, "Passenger call at : (" + lat + "," +lon + ")");
		}

		////////////////////////////////////////////////////////////////
		// ambulance destinations
		// todo: ignore for now? Modify if you want to have lines drawn between vehicles and their destinations.
		
		function addTaxiDest(id) {
			t = taxis[id]
			t.destLine = new L.polyline(
				[], // coords, empty for now
				{
					color: "#0033ff",
					weight: 3,
					opacity: .5
				}
			)
			if (show_dests.checked) {
				map.addLayer(t.destLine)
			}
		}
		
		function updateAmbDest(a) {
			// 'a' is ambulance from julia
			ambs[a.index].destLine.setLatLngs([
				[a.currentLoc.y, a.currentLoc.x],
				[a.endLoc.y, a.endLoc.x]
			])
		}
		
		function showAmbDests() {
			for (id in ambs) {
				map.addLayer(ambs[id].destLine)
			}
		}
		
		function hideAmbDests() {
			for (id in taxis) {
				map.removeLayer(taxis[id].destLine)
			}
		}
		

		////////////////////////////////////////////////////////////////
		// misc
		
		function circleMarker(lat, lon, size, color, opacity, popup) {
			return L.circle([lat, lon], size, {
				fillColor: color,
				fillOpacity: opacity,
				stroke: true,
				color: color,
				opacity: 1, // testing
				weight: 5
			}).addTo(map).bindPopup(popup);
		}
		
		function idToIndex(id) {
			// convert julia index to js index
			return id-1;
		}
		
		function indexToId(index) {
			// convert js index to julia index
			return index+1;
		}
		
		function min(array) {
			return Math.min(...array);
		}
		
		function max(array) {
			return Math.max(...array);
		}
		
		////////////////////////////////////////////////////////////////
		// debugging
		
		var popup = L.popup();
		function onMapClick(e) {
			popup
				.setLatLng(e.latlng)
				.setContent(e.latlng.toString())
				.openOn(map);
		}
		map.on('click', onMapClick);
		
		function showLatLon(lat, lon) {
			latlng = new L.LatLng(lat, lon)
			popup
				.setLatLng(latlng)
				.setContent(latlng.toString())
				.openOn(map);
		}
		
		var miscMarkers = {}
		
		function addMiscMarker(key, popup, lat, lon) {
			if (key in miscMarkers) {
				throw new Error("Key already exists")
				return
			}
			miscMarkers[key] = new miscMarker(popup, lat, lon);
		}
		
		function miscMarker(popup, lat, lon) {
			this.marker = circleMarker(lat, lon, 10, 'grey', 0.8, popup)
		}
		
		function removeMiscMarker(key) {
			if (key in miscMarkers) {
				map.removeLayer(miscMarkers[key].marker)
				delete miscMarkers[key]
			}
		}
		
		function removeMiscMarkers() {
			for (m in miscMarkers) {
				removeMiscMarker(m)
			}
		}
		
		var miscLines = {}
		
		function addMiscLine(key, popup, latLonPairs) {
			if (key in miscLines) {
				throw new Error("Key already exists")
				return
			}
			miscLines[key] = new miscLine(popup, latLonPairs);
		}
		
		function miscLine(popup, latLonPairs) {
			this.marker = L.polyline(
				latLonPairs,
				{
					color: 'grey',
					weight: 3,
					opacity: 1
				}
			).addTo(map);
		}
		
		function removeMiscLine(key) {
			if (key in miscLines) {
				map.removeLayer(miscLines[key].marker)
				delete miscLines[key]
			}
		}
		
		function removeMiscLines() {
			for (m in miscLines) {
				removeMiscLine(m)
			}
		}
		
		function approxDist(lat1, lon1, lat2, lon2) {
			var c = Math.cos(lat1 / 180 * Math.PI)
			return Math.sqrt(Math.pow(lat1 - lat2, 2) + Math.pow(c * (lon1 - lon2), 2)) * 40000 / 360 // approximate distance, km, for two nearby locations
		}
		
		function show(object) {
			// object could be: ambulance, call, hospital, station
			object.marker.openPopup()
		}
		
	</script>

</body>
</html>
